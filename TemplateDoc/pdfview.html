<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Universal File Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
      .file-viewer {
        width: 100%;
        height: 600px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .pdf-canvas {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
      }
      .pdf-container {
        overflow: auto;
        height: 600px;
        text-align: center;
        padding: 10px;
      }
      .text-viewer {
        padding: 10px;
        font-family: "Courier New", monospace;
        white-space: pre-wrap;
        overflow: auto;
        background-color: #f5f5f5;
      }
      .error-message {
        color: red;
        padding: 20px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="viewer-container"></div>

    <script>
      // Set PDF.js worker
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

      function createFileViewer(containerId, fileData, mimeType) {
        const container = document.getElementById(containerId);
        if (!container) {
          console.error("Container not found:", containerId);
          return;
        }

        try {
          // Auto-detect if data is base64
          const isBase64 =
            /^[A-Za-z0-9+/]*={0,2}$/.test(fileData) &&
            fileData.length % 4 === 0;

          if (mimeType.toLowerCase().includes("pdf")) {
            // Handle PDF with canvas
            let pdfData;

            if (isBase64) {
              // Convert base64 to Uint8Array
              const binaryString = atob(fileData);
              pdfData = new Uint8Array(binaryString.length);
              for (let i = 0; i < binaryString.length; i++) {
                pdfData[i] = binaryString.charCodeAt(i);
              }
            } else {
              // Convert binary string to Uint8Array
              pdfData = new Uint8Array(fileData.length);
              for (let i = 0; i < fileData.length; i++) {
                pdfData[i] = fileData.charCodeAt(i);
              }
            }

            container.innerHTML =
              '<div class="pdf-container"><div>Loading PDF...</div></div>';

            // Load PDF
            pdfjsLib
              .getDocument({ data: pdfData })
              .promise.then(function (pdf) {
                const pdfContainer = container.querySelector(".pdf-container");
                pdfContainer.innerHTML = "";

                // Render all pages
                const numPages = pdf.numPages;

                for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                  pdf.getPage(pageNum).then(function (page) {
                    const scale = 1.5;
                    const viewport = page.getViewport({ scale: scale });

                    const canvas = document.createElement("canvas");
                    canvas.className = "pdf-canvas";
                    canvas.style.marginBottom = "10px";
                    const context = canvas.getContext("2d");
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    pdfContainer.appendChild(canvas);

                    const renderContext = {
                      canvasContext: context,
                      viewport: viewport,
                    };

                    page.render(renderContext);
                  });
                }
              })
              .catch(function (error) {
                container.innerHTML = `
                <div class="error-message">
                  Error loading PDF: ${error.message}
                </div>
              `;
              });
          } else if (mimeType.toLowerCase().includes("text")) {
            // Handle Text
            let textContent;

            if (isBase64) {
              textContent = atob(fileData);
            } else {
              textContent = fileData;
            }

            container.innerHTML = `
                        <div class="file-viewer text-viewer">${textContent}</div>
                    `;
          } else {
            container.innerHTML = `
                        <div class="error-message">
                            Unsupported file type: ${mimeType}
                        </div>
                    `;
          }
        } catch (error) {
          container.innerHTML = `
                    <div class="error-message">
                        Error loading file: ${error.message}
                    </div>
                `;
          console.error("File viewer error:", error);
        }
      }

      // Make function globally available
      window.createFileViewer = createFileViewer;

      // Example usage:
      // createFileViewer('viewer-container', 'your-base64-or-binary-data', 'application/pdf');
      // createFileViewer('viewer-container', 'Hello World!', 'text/plain');
    </script>
  </body>
</html>
